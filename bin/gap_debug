#!/bin/bash

# Gap Debug - Comprehensive debugging for gap workflow issues

echo "ğŸ› GAP COMPREHENSIVE DEBUG MODE"
echo "==============================="
echo

# Test 1: Environment and Path
echo "ğŸŒ ENVIRONMENT CHECKS"
echo "-------------------"
echo "Current directory: $(pwd)"
echo "Shell: $SHELL"
echo "User: $USER"
echo "PATH includes bin/: $(echo $PATH | grep -q "$(pwd)/bin" && echo "âœ… YES" || echo "âŒ NO")"
echo

# Test 2: Git Repository Status
echo "ğŸ“ GIT REPOSITORY CHECKS"
echo "----------------------"
if git rev-parse --git-dir > /dev/null 2>&1; then
  echo "âœ… In a git repository"
  echo "Branch: $(git branch --show-current)"
  echo "Remote: $(git remote -v | head -1 | awk '{print $2}' || echo 'None')"
  echo "Uncommitted changes: $(git status --porcelain | wc -l | tr -d ' ') files"
else
  echo "âŒ Not in a git repository"
fi
echo

# Test 3: Required Executables
echo "ğŸ”§ EXECUTABLE CHECKS"
echo "------------------"
for cmd in git ruby rails bundle brakeman rubocop; do
  if command -v "$cmd" &> /dev/null; then
    echo "âœ… $cmd: $(which $cmd)"
  else
    echo "âŒ $cmd: not found"
  fi
done
echo

# Test 4: Gap Script Files
echo "ğŸ“œ GAP SCRIPT CHECKS"
echo "------------------"
for script in gap gap_dry_run gap_preview gap_debug set_commit_message update_commit_message cursor_checks rubocop_check; do
  if [ -f "bin/$script" ]; then
    if [ -x "bin/$script" ]; then
      echo "âœ… bin/$script: exists and executable"
    else
      echo "âš ï¸  bin/$script: exists but not executable"
    fi
  else
    echo "âŒ bin/$script: missing"
  fi
done
echo

# Test 5: Commit Message System
echo "ğŸ’¬ COMMIT MESSAGE SYSTEM"
echo "----------------------"
if [ -f ".commit_message" ]; then
  echo "âœ… .commit_message file exists"
  echo "Content: '$(cat .commit_message)'"
  echo "Size: $(wc -c < .commit_message) bytes"
else
  echo "âŒ .commit_message file does not exist"
fi

# Test writing and reading commit message
echo "Testing commit message operations..."
test_msg="Test message $(date +%s)"
echo "$test_msg" > .commit_message.test
if [ -f ".commit_message.test" ] && [ "$(cat .commit_message.test)" = "$test_msg" ]; then
  echo "âœ… Can write and read commit message files"
  rm .commit_message.test
else
  echo "âŒ Cannot write/read commit message files"
fi
echo

# Test 6: Terminal Detection
echo "ğŸ–¥ï¸  TERMINAL DETECTION"
echo "-------------------"
echo "stdin is terminal: $([ -t 0 ] && echo "âœ… YES" || echo "âŒ NO")"
echo "stdout is terminal: $([ -t 1 ] && echo "âœ… YES" || echo "âŒ NO")"
echo "stderr is terminal: $([ -t 2 ] && echo "âœ… YES" || echo "âŒ NO")"
echo "TTY: $(tty 2>/dev/null || echo 'none')"
echo

# Test 7: Individual Check Commands
echo "ğŸ” INDIVIDUAL CHECK TESTS"
echo "-----------------------"

# Brakeman
echo -n "Brakeman: "
if bin/brakeman --version > /dev/null 2>&1; then
  echo "âœ… Available and working"
else
  echo "âŒ Not working"
fi

# Rubocop
echo -n "Rubocop: "
if bin/rubocop --version > /dev/null 2>&1; then
  echo "âœ… Available and working"
else
  echo "âŒ Not working"
fi

# Rails
echo -n "Rails: "
if bin/rails --version > /dev/null 2>&1; then
  echo "âœ… Available and working"
else
  echo "âŒ Not working"
fi

# Importmap
echo -n "Importmap: "
if bin/importmap --help > /dev/null 2>&1; then
  echo "âœ… Available and working"
else
  echo "âŒ Not working"
fi
echo

# Test 8: File Permissions
echo "ğŸ”’ FILE PERMISSIONS"
echo "----------------"
echo "bin/ directory permissions: $(ls -ld bin | awk '{print $1}')"
echo "Current directory writable: $([ -w . ] && echo "âœ… YES" || echo "âŒ NO")"
echo "Can create files: $(touch .debug_test 2>/dev/null && rm .debug_test && echo "âœ… YES" || echo "âŒ NO")"
echo

# Test 9: Gap Function Test
echo "âš™ï¸  GAP FUNCTION TESTS"
echo "-------------------"

# Test get_commit_message function
if [ -f ".commit_message" ]; then
  echo "âœ… Stored commit message would be used"
else
  echo "âš ï¸  No stored commit message (would need to provide one)"
fi
echo

echo "ğŸ¯ SUMMARY & RECOMMENDATIONS"
echo "============================="

# Check critical issues
issues=0

# Git repo check
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "âŒ CRITICAL: Not in a git repository"
  ((issues++))
fi

# Executable check
for cmd in git ruby rails; do
  if ! command -v "$cmd" &> /dev/null; then
    echo "âŒ CRITICAL: $cmd not found"
    ((issues++))
  fi
done

# Script permissions
for script in gap gap_dry_run; do
  if [ ! -x "bin/$script" ]; then
    echo "âš ï¸  WARNING: bin/$script not executable"
  fi
done

if [ $issues -eq 0 ]; then
  echo "âœ… All critical components working!"
  echo "ğŸš€ Gap should work properly"
else
  echo "âŒ Found $issues critical issues"
  echo "ğŸ”§ Fix these issues before using gap"
fi

echo
echo "ğŸ’¡ Run 'gap_dry_run \"test message\"' to test the full workflow" 